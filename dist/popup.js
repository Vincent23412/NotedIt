(()=>{"use strict";var e=function(e,t,n,o){return new(n||(n=Promise))((function(c,i){function r(e){try{l(o.next(e))}catch(e){i(e)}}function a(e){try{l(o.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?c(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}l((o=o.apply(e,t||[])).next())}))};function t(e){return new Promise((t=>{chrome.storage.local.get(e,(n=>{t(n[e])}))}))}function n(e){return new Promise((t=>{chrome.storage.local.set(e,(()=>{t()}))}))}const o=()=>e(void 0,void 0,void 0,(function*(){confirm("確定要刪除所有筆記嗎？此操作無法復原！")&&(yield chrome.storage.local.remove("notes"),document.getElementById("note-list").innerHTML="",console.log("已清除所有筆記"))})),c=(e,t)=>{const n=t.filter((e=>e.content&&""!==e.content.trim())).map((e=>e.content));console.log("匯出群組：",e);const o={sortedKey:e,content:n},c=new Blob([JSON.stringify(o,null,2)],{type:"application/json"}),i=e.replace(/[^a-z0-9]/gi,"_").toLowerCase(),r=document.createElement("a");r.href=URL.createObjectURL(c),r.download=`notes_export_${i}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r)};var i=function(e,t,n,o){return new(n||(n=Promise))((function(c,i){function r(e){try{l(o.next(e))}catch(e){i(e)}}function a(e){try{l(o.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?c(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}l((o=o.apply(e,t||[])).next())}))};document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("note-list"),t=document.getElementById("note"),n=document.getElementById("save-button"),c=document.getElementById("sort-select"),i=document.getElementById("clear-button"),d=document.getElementById("import-button"),s=document.getElementById("import-file");i.addEventListener("click",o),r(e,c.value),c.addEventListener("change",(()=>{r(e,c.value)})),d.addEventListener("click",(()=>{s.click()})),s.addEventListener("change",l),n.addEventListener("click",a(e,t))}));const r=(o,a="tags")=>i(void 0,void 0,void 0,(function*(){const l=(yield t("notes"))||[];o.innerHTML="";const d=function(e,t){const n={};for(const o of e){const e=t(o),c=String(null!=e?e:"未分類");n[c]||(n[c]=[]),n[c].push(o)}return n}(l,(e=>{const t=e[a];return Array.isArray(t)?t.join(",")||"未分類":String(null!=t?t:"未分類")}));for(const[l,s]of Object.entries(d)){const d=document.createElement("li");d.className="note-item";const u=document.createElement("div");u.className="group-header";const m=document.createElement("span");"url"===a?m.innerHTML=`<a href="${l}" target="_blank" class="note-url">🔗 前往網頁</a>`:m.textContent="tags"===a?`🏷️ Tag：${l}`:`📁 ${a}: ${l}`;const v=document.createElement("button");v.textContent="📤 匯出",v.className="export-group-btn",v.addEventListener("click",(()=>{c(l,s)})),u.appendChild(m),u.appendChild(v),d.appendChild(u),s.forEach((c=>{const l=document.createElement("div");l.className="note-content";const s=document.createElement("a");s.href=c.url,s.target="_blank",s.rel="noopener noreferrer";const u=document.createElement("img");u.src=c.iconUrl||"icons/default-icon.png",u.alt="icon",u.className="note-icon",s.appendChild(u);const m=document.createElement("span");m.textContent=c.content,m.className="note-text";const v=document.createElement("button");v.textContent="🗑",v.className="note-delete-btn",v.addEventListener("click",(l=>i(void 0,void 0,void 0,(function*(){var i;l.stopPropagation(),confirm("確定要刪除這筆筆記嗎？")&&(yield(i=c.id,e(void 0,void 0,void 0,(function*(){const e=((yield t("notes"))||[]).filter((e=>e.id!==i));yield n({notes:e}),console.log(`已刪除筆記（id=${i}）`)}))),yield r(o,a))})))),l.appendChild(s),l.appendChild(m),l.appendChild(v),d.appendChild(l)})),o.appendChild(d)}})),a=(e,o)=>()=>i(void 0,void 0,void 0,(function*(){var c,i,a;const l=o.value;if(!l)return;const d=document.getElementById("tag-input").value.split(",").map((e=>e.trim())).filter((e=>""!==e)),[s,u]=yield Promise.all([t("notes"),chrome.tabs.query({active:!0,currentWindow:!0})]),m=(null===(c=u[0])||void 0===c?void 0:c.url)||"unknown",v=(null===(i=u[0])||void 0===i?void 0:i.favIconUrl)||"",p=s||[],f={id:`${m}-${l}`,title:(null===(a=u[0])||void 0===a?void 0:a.title)||"unknown",content:l,url:m,iconUrl:v,hostname:"unknown"!==m?new URL(m).hostname:"unknown",createdAt:Date.now(),tags:d};p.push(f),p.sort(((e,t)=>e.hostname.charCodeAt(0)-t.hostname.charCodeAt(0))),yield n({notes:p}),o.value="",r(e)})),l=e=>i(void 0,void 0,void 0,(function*(){var o;const c=null===(o=e.target.files)||void 0===o?void 0:o[0];if(c)try{const e=yield c.text(),o=JSON.parse(e),i=Array.isArray(o)?o:Array.isArray(o.content)?o.content:[];if(!i.length)return void alert("⚠️ 匯入格式錯誤或沒有任何筆記！");const a=(yield t("notes"))||[],l=i.map((e=>Object.assign(Object.assign({},e),{id:crypto.randomUUID()}))),d=[...a,...l];yield n({notes:d}),alert(`✅ 已匯入 ${l.length} 筆筆記！`);const s=document.getElementById("note-list"),u=document.getElementById("sort-select");r(s,u.value)}catch(e){alert("❌ 匯入失敗，檔案格式可能錯誤！"),console.error(e)}finally{e.target.value=""}}))})();