(()=>{"use strict";var t=function(t,e,n,o){return new(n||(n=Promise))((function(i,c){function l(t){try{r(o.next(t))}catch(t){c(t)}}function d(t){try{r(o.throw(t))}catch(t){c(t)}}function r(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(l,d)}r((o=o.apply(t,e||[])).next())}))};function e(t){return new Promise((e=>{chrome.storage.local.get(t,(n=>{e(n[t])}))}))}function n(t){return new Promise((e=>{chrome.storage.local.set(t,(()=>{e()}))}))}const o=()=>t(void 0,void 0,void 0,(function*(){confirm("確定要刪除所有筆記嗎？此操作無法復原！")&&(yield chrome.storage.local.remove("notes"),document.getElementById("note-list").innerHTML="",console.log("已清除所有筆記"))})),i=(t,e)=>{const n=e.filter((t=>t.content&&""!==t.content.trim())).map((t=>t.content));console.log("匯出群組：",t);const o={sortedKey:t,content:n},i=new Blob([JSON.stringify(o,null,2)],{type:"application/json"}),c=t.replace(/[^a-z0-9]/gi,"_").toLowerCase(),l=document.createElement("a");l.href=URL.createObjectURL(i),l.download=`notes_export_${c}.json`,document.body.appendChild(l),l.click(),document.body.removeChild(l)};var c=function(t,e,n,o){return new(n||(n=Promise))((function(i,c){function l(t){try{r(o.next(t))}catch(t){c(t)}}function d(t){try{r(o.throw(t))}catch(t){c(t)}}function r(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(l,d)}r((o=o.apply(t,e||[])).next())}))};function l(t){return c(this,void 0,void 0,(function*(){if(t.has("countIntervalRef")&&null!==t.get("countIntervalRef"))return;const o=(yield e("timers"))||[],i=o.find((e=>e.item===t.get("item")));if(!i)return;if(!i.isStop){let e=Math.floor((Date.now()-i.startTime)/1e3);t.set("time",e)}i.isStop=!1,yield n({timers:o});const l=window.setInterval((()=>c(this,void 0,void 0,(function*(){const e=t.get("time"),n=Math.floor(e/60),o=e%60;t.get("timerDisplay").textContent=`${String(n).padStart(2,"0")}:${String(o).padStart(2,"0")}`,t.set("time",e+1)}))),1e3);t.set("countIntervalRef",l)}))}var d=function(t,e,n,o){return new(n||(n=Promise))((function(i,c){function l(t){try{r(o.next(t))}catch(t){c(t)}}function d(t){try{r(o.throw(t))}catch(t){c(t)}}function r(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(l,d)}r((o=o.apply(t,e||[])).next())}))};document.addEventListener("DOMContentLoaded",(()=>d(void 0,void 0,void 0,(function*(){var t;const i=document.getElementById("note-list"),l=document.getElementById("note"),u=document.getElementById("save-button"),v=document.getElementById("sort-select"),f=document.getElementById("clear-button"),p=document.getElementById("import-button"),y=document.getElementById("import-file"),h=document.getElementById("add-timer-btn"),g=document.getElementById("new-timer-name");f.addEventListener("click",o),r(i,v.value),v.addEventListener("change",(()=>{r(i,v.value)})),p.addEventListener("click",(()=>{y.click()})),y.addEventListener("change",s),u.addEventListener("click",a(i,l)),h.addEventListener("click",(()=>d(void 0,void 0,void 0,(function*(){yield function(t,o){return c(this,void 0,void 0,(function*(){const i=(yield e("timers"))||[];for(const e of i)if(e.item===t)return;const c={item:t,startTime:o,isStop:!1,time:0};i.push(c),yield n({timers:i})}))}(g.value,Date.now()),g.value="",yield m()})))),null===(t=document.getElementById("switch-to-timer"))||void 0===t||t.addEventListener("click",(()=>d(void 0,void 0,void 0,(function*(){var t;document.getElementById("note-tab").style.display="none",document.getElementById("timer-tab").style.display="block",document.getElementById("switch-to-timer").style.display="none",document.getElementById("switch-to-note").style.display="block";const n=yield e("timers");console.log(n,"timers"),n&&n.length>0&&m(),null===(t=document.getElementById("switch-to-note"))||void 0===t||t.addEventListener("click",(()=>{document.getElementById("note-tab").style.display="block",document.getElementById("timer-tab").style.display="none",document.getElementById("switch-to-timer").style.display="block",document.getElementById("switch-to-note").style.display="none"}))}))))}))));const r=(o,c="tags")=>d(void 0,void 0,void 0,(function*(){const l=(yield e("notes"))||[];o.innerHTML="";const a=function(t,e){const n={};for(const o of t){const t=e(o),i=String(null!=t?t:"未分類");n[i]||(n[i]=[]),n[i].push(o)}return n}(l,(t=>{const e=t[c];return Array.isArray(e)?e.join(",")||"未分類":String(null!=e?e:"未分類")}));for(const[l,s]of Object.entries(a)){const a=document.createElement("li");a.className="note-item";const m=document.createElement("div");m.className="group-header";const u=document.createElement("span");"url"===c?u.innerHTML=`<a href="${l}" target="_blank" class="note-url">🔗 前往網頁</a>`:u.textContent="tags"===c?`🏷️ Tag：${l}`:`📁 ${c}: ${l}`;const v=document.createElement("button");v.textContent="📤 匯出",v.className="export-group-btn",v.addEventListener("click",(()=>{i(l,s)})),m.appendChild(u),m.appendChild(v),a.appendChild(m),s.forEach((i=>{const l=document.createElement("div");l.className="note-content";const s=document.createElement("a");s.href=i.url,s.target="_blank",s.rel="noopener noreferrer";const m=document.createElement("img");m.src=i.iconUrl||"icons/default-icon.png",m.alt="icon",m.className="note-icon",s.appendChild(m);const u=document.createElement("span");u.textContent=i.content,u.className="note-text";const v=document.createElement("button");v.textContent="🗑",v.className="note-delete-btn",v.addEventListener("click",(l=>d(void 0,void 0,void 0,(function*(){var d;l.stopPropagation(),confirm("確定要刪除這筆筆記嗎？")&&(yield(d=i.id,t(void 0,void 0,void 0,(function*(){const t=((yield e("notes"))||[]).filter((t=>t.id!==d));yield n({notes:t}),console.log(`已刪除筆記（id=${d}）`)}))),yield r(o,c))})))),l.appendChild(s),l.appendChild(u),l.appendChild(v),a.appendChild(l)})),o.appendChild(a)}})),a=(t,o)=>()=>d(void 0,void 0,void 0,(function*(){var i,c,l;const d=o.value;if(!d)return;const a=document.getElementById("tag-input").value.split(",").map((t=>t.trim())).filter((t=>""!==t)),[s,m]=yield Promise.all([e("notes"),chrome.tabs.query({active:!0,currentWindow:!0})]),u=(null===(i=m[0])||void 0===i?void 0:i.url)||"unknown",v=(null===(c=m[0])||void 0===c?void 0:c.favIconUrl)||"",f=s||[],p={id:`${u}-${d}`,title:(null===(l=m[0])||void 0===l?void 0:l.title)||"unknown",content:d,url:u,iconUrl:v,hostname:"unknown"!==u?new URL(u).hostname:"unknown",createdAt:Date.now(),tags:a};f.push(p),f.sort(((t,e)=>t.hostname.charCodeAt(0)-e.hostname.charCodeAt(0))),console.log("notes data",f),yield n({notes:f}),o.value="",r(t)})),s=t=>d(void 0,void 0,void 0,(function*(){var o;const i=null===(o=t.target.files)||void 0===o?void 0:o[0];if(i)try{const t=yield i.text(),o=JSON.parse(t),c=Array.isArray(o)?o:Array.isArray(o.content)?o.content:[];if(!c.length)return void alert("⚠️ 匯入格式錯誤或沒有任何筆記！");const l=(yield e("notes"))||[],d=c.map((t=>Object.assign(Object.assign({},t),{id:crypto.randomUUID()}))),a=[...l,...d];yield n({notes:a}),alert(`✅ 已匯入 ${d.length} 筆筆記！`);const s=document.getElementById("note-list"),m=document.getElementById("sort-select");r(s,m.value)}catch(t){alert("❌ 匯入失敗，檔案格式可能錯誤！"),console.error(t)}finally{t.target.value=""}}));function m(){return d(this,void 0,void 0,(function*(){const t=(yield e("timers"))||[],o=document.getElementById("timer-list");o.innerHTML="",t.forEach((t=>d(this,void 0,void 0,(function*(){const i=document.createElement("li");i.className="timer-item";const r=document.createElement("div");r.className="timer-header";const a=document.createElement("div");a.className="timer-name",a.textContent=t.item;const s=document.createElement("div");s.className="timer-time";const u=Math.floor(t.time/60),v=t.time%60;s.textContent=`${String(u).padStart(2,"0")}:${String(v).padStart(2,"0")}`,r.appendChild(a),r.appendChild(s);const f=document.createElement("div");f.className="timer-controls";const p=document.createElement("button");p.className="start-btn",p.textContent="▶️";const y=document.createElement("button");y.className="pause-btn",y.textContent="⏸";const h=document.createElement("button");h.className="reset-btn",h.textContent="🔄";const g=document.createElement("button");g.className="delete-btn",g.textContent="❌",f.appendChild(p),f.appendChild(y),f.appendChild(h),f.appendChild(g),i.appendChild(r),i.appendChild(f),o.appendChild(i);const E=new Map;for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&E.set(e,t[e]);E.set("timerDisplay",s),p.addEventListener("click",(()=>{l(E)})),y.addEventListener("click",function(t){return()=>c(this,void 0,void 0,(function*(){if(null!==t.get("countIntervalRef")){clearInterval(t.get("countIntervalRef")),t.set("countIntervalRef",null);const o=(yield e("timers"))||[];if(0===o.length)return;const i=o.find((e=>e.item===t.get("item")));if(!i)return;i.isStop=!0,i.time=t.get("time"),yield n({timers:o})}}))}(E)),h.addEventListener("click",function(t){return()=>c(this,void 0,void 0,(function*(){t.get("countIntervalRef")&&(clearInterval(t.get("countIntervalRef")),t.delete("countIntervalRef")),t.set("time",0),t.get("timerDisplay").textContent="00:00",t.set("countIntervalRef",null);const o=(yield e("timers"))||[],i=o.find((e=>e.item===t.get("item")));i&&(i.time=0,i.isStop=!0,i.startTime=Date.now(),yield n({timers:o}))}))}(E)),g.addEventListener("click",(()=>d(this,void 0,void 0,(function*(){yield function(t){return c(this,void 0,void 0,(function*(){const o=(yield e("timers"))||[],i=o.findIndex((e=>e.item===t.get("item")));-1!==i&&(o.splice(i,1),yield n({timers:o}))}))}(E),m()})))),!1===t.isStop&&(yield l(E))}))))}))}})();