(()=>{"use strict";var e=function(e,n,t,o){return new(t||(t=Promise))((function(c,i){function a(e){try{l(o.next(e))}catch(e){i(e)}}function r(e){try{l(o.throw(e))}catch(e){i(e)}}function l(e){var n;e.done?c(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(a,r)}l((o=o.apply(e,n||[])).next())}))};function n(e){return new Promise((n=>{chrome.storage.local.get(e,(t=>{n(t[e])}))}))}function t(e){return new Promise((n=>{chrome.storage.local.set(e,(()=>{n()}))}))}const o=()=>e(void 0,void 0,void 0,(function*(){confirm("確定要刪除所有筆記嗎？此操作無法復原！")&&(yield chrome.storage.local.remove("notes"),document.getElementById("note-list").innerHTML="",console.log("已清除所有筆記"))})),c=(e,n)=>{const t=n.filter((e=>e.content&&""!==e.content.trim())).map((e=>e.content));console.log("匯出群組：",e);const o={sortedKey:e,content:t},c=new Blob([JSON.stringify(o,null,2)],{type:"application/json"}),i=e.replace(/[^a-z0-9]/gi,"_").toLowerCase(),a=document.createElement("a");a.href=URL.createObjectURL(c),a.download=`notes_export_${i}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a)};var i=function(e,n,t,o){return new(t||(t=Promise))((function(c,i){function a(e){try{l(o.next(e))}catch(e){i(e)}}function r(e){try{l(o.throw(e))}catch(e){i(e)}}function l(e){var n;e.done?c(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(a,r)}l((o=o.apply(e,n||[])).next())}))};document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("note-list"),n=document.getElementById("note"),t=document.getElementById("save-button"),c=document.getElementById("sort-select");document.getElementById("clear-button").addEventListener("click",o),a(e,c.value),c.addEventListener("change",(()=>{a(e,c.value)})),t.addEventListener("click",r(e,n))}));const a=(o,r="tags")=>i(void 0,void 0,void 0,(function*(){const l=(yield n("notes"))||[];o.innerHTML="";const d=function(e,n){const t={};for(const o of e){const e=n(o),c=String(null!=e?e:"未分類");t[c]||(t[c]=[]),t[c].push(o)}return t}(l,(e=>{const n=e[r];return Array.isArray(n)?n.join(",")||"未分類":String(null!=n?n:"未分類")}));for(const[l,s]of Object.entries(d)){const d=document.createElement("li");d.className="note-item";const u=document.createElement("div");u.className="group-header";const m=document.createElement("span");"url"===r?m.innerHTML=`<a href="${l}" target="_blank" class="note-url">🔗 前往網頁</a>`:m.textContent="tags"===r?`🏷️ Tag：${l}`:`📁 ${r}: ${l}`;const v=document.createElement("button");v.textContent="📤 匯出",v.className="export-group-btn",v.addEventListener("click",(()=>{c(l,s)})),u.appendChild(m),u.appendChild(v),d.appendChild(u),s.forEach((c=>{const l=document.createElement("div");l.className="note-content";const s=document.createElement("a");s.href=c.url,s.target="_blank",s.rel="noopener noreferrer";const u=document.createElement("img");u.src=c.iconUrl||"icons/default-icon.png",u.alt="icon",u.className="note-icon",s.appendChild(u);const m=document.createElement("span");m.textContent=c.content,m.className="note-text";const v=document.createElement("button");v.textContent="🗑",v.className="note-delete-btn",v.addEventListener("click",(l=>i(void 0,void 0,void 0,(function*(){var i;l.stopPropagation(),confirm("確定要刪除這筆筆記嗎？")&&(yield(i=c.id,e(void 0,void 0,void 0,(function*(){const e=((yield n("notes"))||[]).filter((e=>e.id!==i));yield t({notes:e}),console.log(`已刪除筆記（id=${i}）`)}))),yield a(o,r))})))),l.appendChild(s),l.appendChild(m),l.appendChild(v),d.appendChild(l)})),o.appendChild(d)}})),r=(e,o)=>()=>i(void 0,void 0,void 0,(function*(){var c,i,r;const l=o.value;if(!l)return;const d=document.getElementById("tag-input").value.split(",").map((e=>e.trim())).filter((e=>""!==e)),[s,u]=yield Promise.all([n("notes"),chrome.tabs.query({active:!0,currentWindow:!0})]),m=(null===(c=u[0])||void 0===c?void 0:c.url)||"unknown",v=(null===(i=u[0])||void 0===i?void 0:i.favIconUrl)||"",p=s||[],f={id:`${m}-${l}`,title:(null===(r=u[0])||void 0===r?void 0:r.title)||"unknown",content:l,url:m,iconUrl:v,hostname:"unknown"!==m?new URL(m).hostname:"unknown",createdAt:Date.now(),tags:d};p.push(f),p.sort(((e,n)=>e.hostname.charCodeAt(0)-n.hostname.charCodeAt(0))),yield t({notes:p}),o.value="",a(e)}))})();