(()=>{"use strict";var t=function(t,e,n,o){return new(n||(n=Promise))((function(i,c){function l(t){try{r(o.next(t))}catch(t){c(t)}}function d(t){try{r(o.throw(t))}catch(t){c(t)}}function r(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(l,d)}r((o=o.apply(t,e||[])).next())}))};function e(t){return new Promise((e=>{chrome.storage.local.get(t,(n=>{e(n[t])}))}))}function n(t){return new Promise((e=>{chrome.storage.local.set(t,(()=>{e()}))}))}const o=()=>t(void 0,void 0,void 0,(function*(){confirm("確定要刪除所有筆記嗎？此操作無法復原！")&&(yield chrome.storage.local.remove("notes"),document.getElementById("note-list").innerHTML="",console.log("已清除所有筆記"))})),i=(t,e)=>{const n=e.filter((t=>t.content&&""!==t.content.trim())).map((t=>t.content));console.log("匯出群組：",t);const o={sortedKey:t,content:n},i=new Blob([JSON.stringify(o,null,2)],{type:"application/json"}),c=t.replace(/[^a-z0-9]/gi,"_").toLowerCase(),l=document.createElement("a");l.href=URL.createObjectURL(i),l.download=`notes_export_${c}.json`,document.body.appendChild(l),l.click(),document.body.removeChild(l)};var c=function(t,e,n,o){return new(n||(n=Promise))((function(i,c){function l(t){try{r(o.next(t))}catch(t){c(t)}}function d(t){try{r(o.throw(t))}catch(t){c(t)}}function r(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(l,d)}r((o=o.apply(t,e||[])).next())}))};function l(t,o,i){return c(this,void 0,void 0,(function*(){let l=(yield e("timers"))||[];0===l.length&&(yield function(t,o){return c(this,void 0,void 0,(function*(){const t=(yield e("timers"))||[],i={item:"test",startTime:o,isStop:!1,time:0};t.push(i),yield n({timers:t})}))}(0,Math.floor(Date.now()/1e3)),l=(yield e("timers"))||[]),l[0].isStop?(i.value=l[0].time,l[0].isStop=!1,yield n({timers:l})):i.value=Math.floor(Date.now()/1e3-l[0].startTime),function(t,e,n){null===e.id&&(e.id=window.setInterval((()=>{const e=t.value,o=Math.floor(e/60),i=e%60;n.textContent=`${String(o).padStart(2,"0")}:${String(i).padStart(2,"0")}`,t.value++}),1e3))}(i,t,o)}))}var d=function(t,e,n,o){return new(n||(n=Promise))((function(i,c){function l(t){try{r(o.next(t))}catch(t){c(t)}}function d(t){try{r(o.throw(t))}catch(t){c(t)}}function r(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(l,d)}r((o=o.apply(t,e||[])).next())}))};document.addEventListener("DOMContentLoaded",(()=>d(void 0,void 0,void 0,(function*(){var t,i;const u=document.getElementById("note-list"),m=document.getElementById("note"),v=document.getElementById("save-button"),y=document.getElementById("sort-select"),f=document.getElementById("clear-button"),p=document.getElementById("import-button"),g=document.getElementById("import-file"),h=document.getElementById("startBtn"),E=document.getElementById("pauseBtn"),w=document.getElementById("resetBtn"),I=document.getElementById("timer");f.addEventListener("click",o),r(u,y.value),y.addEventListener("change",(()=>{r(u,y.value)})),p.addEventListener("click",(()=>{g.click()})),g.addEventListener("change",s),v.addEventListener("click",a(u,m));const B={id:null},b={value:0};null===(t=document.getElementById("switch-to-timer"))||void 0===t||t.addEventListener("click",(()=>d(void 0,void 0,void 0,(function*(){document.getElementById("note-tab").style.display="none",document.getElementById("timer-tab").style.display="block",document.getElementById("switch-to-timer").style.display="none",document.getElementById("switch-to-note").style.display="block";const t=yield e("timers");if(t&&t.length>0&&!1===t[0].isStop)yield l(B,I,b);else if(t&&t.length>0&&!0===t[0].isStop){const e=Math.floor(t[0].time/60),n=t[0].time%60;I.textContent=`${String(e).padStart(2,"0")}:${String(n).padStart(2,"0")}`}})))),null===(i=document.getElementById("switch-to-note"))||void 0===i||i.addEventListener("click",(()=>{document.getElementById("note-tab").style.display="block",document.getElementById("timer-tab").style.display="none",document.getElementById("switch-to-timer").style.display="block",document.getElementById("switch-to-note").style.display="none"})),h.addEventListener("click",(()=>d(void 0,void 0,void 0,(function*(){yield l(B,I,b)})))),E.addEventListener("click",function(t,o){return()=>c(this,void 0,void 0,(function*(){null!==t.id&&(clearInterval(t.id),t.id=null);const i=(yield e("timers"))||[];0!==i.length&&(i[0].isStop=!0,i[0].time=o.value,yield n({timers:i}))}))}(B,b)),w.addEventListener("click",function(t,e){return()=>c(this,void 0,void 0,(function*(){t.id&&clearInterval(t.id),yield chrome.storage.local.remove("timers"),e.textContent="00:00"}))}(B,I))}))));const r=(o,c="tags")=>d(void 0,void 0,void 0,(function*(){const l=(yield e("notes"))||[];o.innerHTML="";const a=function(t,e){const n={};for(const o of t){const t=e(o),i=String(null!=t?t:"未分類");n[i]||(n[i]=[]),n[i].push(o)}return n}(l,(t=>{const e=t[c];return Array.isArray(e)?e.join(",")||"未分類":String(null!=e?e:"未分類")}));for(const[l,s]of Object.entries(a)){const a=document.createElement("li");a.className="note-item";const u=document.createElement("div");u.className="group-header";const m=document.createElement("span");"url"===c?m.innerHTML=`<a href="${l}" target="_blank" class="note-url">🔗 前往網頁</a>`:m.textContent="tags"===c?`🏷️ Tag：${l}`:`📁 ${c}: ${l}`;const v=document.createElement("button");v.textContent="📤 匯出",v.className="export-group-btn",v.addEventListener("click",(()=>{i(l,s)})),u.appendChild(m),u.appendChild(v),a.appendChild(u),s.forEach((i=>{const l=document.createElement("div");l.className="note-content";const s=document.createElement("a");s.href=i.url,s.target="_blank",s.rel="noopener noreferrer";const u=document.createElement("img");u.src=i.iconUrl||"icons/default-icon.png",u.alt="icon",u.className="note-icon",s.appendChild(u);const m=document.createElement("span");m.textContent=i.content,m.className="note-text";const v=document.createElement("button");v.textContent="🗑",v.className="note-delete-btn",v.addEventListener("click",(l=>d(void 0,void 0,void 0,(function*(){var d;l.stopPropagation(),confirm("確定要刪除這筆筆記嗎？")&&(yield(d=i.id,t(void 0,void 0,void 0,(function*(){const t=((yield e("notes"))||[]).filter((t=>t.id!==d));yield n({notes:t}),console.log(`已刪除筆記（id=${d}）`)}))),yield r(o,c))})))),l.appendChild(s),l.appendChild(m),l.appendChild(v),a.appendChild(l)})),o.appendChild(a)}})),a=(t,o)=>()=>d(void 0,void 0,void 0,(function*(){var i,c,l;const d=o.value;if(!d)return;const a=document.getElementById("tag-input").value.split(",").map((t=>t.trim())).filter((t=>""!==t)),[s,u]=yield Promise.all([e("notes"),chrome.tabs.query({active:!0,currentWindow:!0})]),m=(null===(i=u[0])||void 0===i?void 0:i.url)||"unknown",v=(null===(c=u[0])||void 0===c?void 0:c.favIconUrl)||"",y=s||[],f={id:`${m}-${d}`,title:(null===(l=u[0])||void 0===l?void 0:l.title)||"unknown",content:d,url:m,iconUrl:v,hostname:"unknown"!==m?new URL(m).hostname:"unknown",createdAt:Date.now(),tags:a};y.push(f),y.sort(((t,e)=>t.hostname.charCodeAt(0)-e.hostname.charCodeAt(0))),console.log("notes data",y),yield n({notes:y}),o.value="",r(t)})),s=t=>d(void 0,void 0,void 0,(function*(){var o;const i=null===(o=t.target.files)||void 0===o?void 0:o[0];if(i)try{const t=yield i.text(),o=JSON.parse(t),c=Array.isArray(o)?o:Array.isArray(o.content)?o.content:[];if(!c.length)return void alert("⚠️ 匯入格式錯誤或沒有任何筆記！");const l=(yield e("notes"))||[],d=c.map((t=>Object.assign(Object.assign({},t),{id:crypto.randomUUID()}))),a=[...l,...d];yield n({notes:a}),alert(`✅ 已匯入 ${d.length} 筆筆記！`);const s=document.getElementById("note-list"),u=document.getElementById("sort-select");r(s,u.value)}catch(t){alert("❌ 匯入失敗，檔案格式可能錯誤！"),console.error(t)}finally{t.target.value=""}}))})();