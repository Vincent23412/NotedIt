(()=>{"use strict";var e=function(e,t,n,o){return new(n||(n=Promise))((function(i,l){function c(e){try{r(o.next(e))}catch(e){l(e)}}function d(e){try{r(o.throw(e))}catch(e){l(e)}}function r(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,d)}r((o=o.apply(e,t||[])).next())}))};function t(e){return new Promise((t=>{chrome.storage.local.get(e,(n=>{t(n[e])}))}))}function n(e){return new Promise((t=>{chrome.storage.local.set(e,(()=>{t()}))}))}const o=()=>e(void 0,void 0,void 0,(function*(){confirm("確定要刪除所有筆記嗎？此操作無法復原！")&&(yield chrome.storage.local.remove("notes"),document.getElementById("note-list").innerHTML="",console.log("已清除所有筆記"))})),i=(e,t)=>{const n=t.filter((e=>e.content&&""!==e.content.trim())).map((e=>e.content));console.log("匯出群組：",e);const o={sortedKey:e,content:n},i=new Blob([JSON.stringify(o,null,2)],{type:"application/json"}),l=e.replace(/[^a-z0-9]/gi,"_").toLowerCase(),c=document.createElement("a");c.href=URL.createObjectURL(i),c.download=`notes_export_${l}.json`,document.body.appendChild(c),c.click(),document.body.removeChild(c)};var l=function(e,t,n,o){return new(n||(n=Promise))((function(i,l){function c(e){try{r(o.next(e))}catch(e){l(e)}}function d(e){try{r(o.throw(e))}catch(e){l(e)}}function r(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,d)}r((o=o.apply(e,t||[])).next())}))};const c=1800;function d(e,o,i){return l(this,void 0,void 0,(function*(){const d=(yield t("timers"))||[];if(null===e.id){if(d.length>0&&!1===d[0].isStop)console.log("A"),i.value=c-Math.floor((Date.now()-d[0].startTime)/1e3),d[0].resTime=i.value,yield n({timers:d});else if(d.length>0&&!0===d[0].isStop)console.log("B"),d[0].isStop=!1,n({timers:d}),i.value=Math.floor(d[0].resTime);else{console.log("C");const e=Date.now();yield function(e,o){return l(this,void 0,void 0,(function*(){const e=(yield t("timers"))||[],i={item:"test",startTime:o,isStop:!1,stopTime:0,resTime:1800};e.push(i),yield n({timers:e})}))}(0,e),i.value=c}!function(e,t,n){null!==t.id&&clearInterval(t.id),t.id=window.setInterval((()=>{let o=e.value;o<0&&(o=0);const i=Math.floor(o/60),l=o%60;n.textContent=`${String(i).padStart(2,"0")}:${String(l).padStart(2,"0")}`,0===o&&(clearInterval(t.id),t.id=null),e.value--}),1e3)}(i,e,o)}}))}var r=function(e,t,n,o){return new(n||(n=Promise))((function(i,l){function c(e){try{r(o.next(e))}catch(e){l(e)}}function d(e){try{r(o.throw(e))}catch(e){l(e)}}function r(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,d)}r((o=o.apply(e,t||[])).next())}))};document.addEventListener("DOMContentLoaded",(()=>r(void 0,void 0,void 0,(function*(){var e,i;const c=document.getElementById("note-list"),m=document.getElementById("note"),v=document.getElementById("save-button"),y=document.getElementById("sort-select"),f=document.getElementById("clear-button"),p=document.getElementById("import-button"),g=document.getElementById("import-file"),h=document.getElementById("startBtn"),E=document.getElementById("pauseBtn"),w=(document.getElementById("resetBtn"),document.getElementById("timer"));f.addEventListener("click",o),a(c,y.value),y.addEventListener("change",(()=>{a(c,y.value)})),p.addEventListener("click",(()=>{g.click()})),g.addEventListener("change",u),v.addEventListener("click",s(c,m));const I={id:null},B={value:0};null===(e=document.getElementById("switch-to-timer"))||void 0===e||e.addEventListener("click",(()=>r(void 0,void 0,void 0,(function*(){document.getElementById("note-tab").style.display="none",document.getElementById("timer-tab").style.display="block",document.getElementById("switch-to-timer").style.display="none",document.getElementById("switch-to-note").style.display="block";const e=yield t("timers");e&&e.length>0&&(yield d(I,w,B))})))),null===(i=document.getElementById("switch-to-note"))||void 0===i||i.addEventListener("click",(()=>{document.getElementById("note-tab").style.display="block",document.getElementById("timer-tab").style.display="none",document.getElementById("switch-to-timer").style.display="block",document.getElementById("switch-to-note").style.display="none"})),h.addEventListener("click",(()=>r(void 0,void 0,void 0,(function*(){yield d(I,w,B)})))),E.addEventListener("click",function(e,o){return()=>l(this,void 0,void 0,(function*(){null!==e.id&&(clearInterval(e.id),e.id=null);const i=(yield t("timers"))||[];0!==i.length&&(i[0].isStop=!0,i[0].resTime=o.value,yield n({timers:i}))}))}(I,B))}))));const a=(o,l="tags")=>r(void 0,void 0,void 0,(function*(){const c=(yield t("notes"))||[];o.innerHTML="";const d=function(e,t){const n={};for(const o of e){const e=t(o),i=String(null!=e?e:"未分類");n[i]||(n[i]=[]),n[i].push(o)}return n}(c,(e=>{const t=e[l];return Array.isArray(t)?t.join(",")||"未分類":String(null!=t?t:"未分類")}));for(const[c,s]of Object.entries(d)){const d=document.createElement("li");d.className="note-item";const u=document.createElement("div");u.className="group-header";const m=document.createElement("span");"url"===l?m.innerHTML=`<a href="${c}" target="_blank" class="note-url">🔗 前往網頁</a>`:m.textContent="tags"===l?`🏷️ Tag：${c}`:`📁 ${l}: ${c}`;const v=document.createElement("button");v.textContent="📤 匯出",v.className="export-group-btn",v.addEventListener("click",(()=>{i(c,s)})),u.appendChild(m),u.appendChild(v),d.appendChild(u),s.forEach((i=>{const c=document.createElement("div");c.className="note-content";const s=document.createElement("a");s.href=i.url,s.target="_blank",s.rel="noopener noreferrer";const u=document.createElement("img");u.src=i.iconUrl||"icons/default-icon.png",u.alt="icon",u.className="note-icon",s.appendChild(u);const m=document.createElement("span");m.textContent=i.content,m.className="note-text";const v=document.createElement("button");v.textContent="🗑",v.className="note-delete-btn",v.addEventListener("click",(c=>r(void 0,void 0,void 0,(function*(){var d;c.stopPropagation(),confirm("確定要刪除這筆筆記嗎？")&&(yield(d=i.id,e(void 0,void 0,void 0,(function*(){const e=((yield t("notes"))||[]).filter((e=>e.id!==d));yield n({notes:e}),console.log(`已刪除筆記（id=${d}）`)}))),yield a(o,l))})))),c.appendChild(s),c.appendChild(m),c.appendChild(v),d.appendChild(c)})),o.appendChild(d)}})),s=(e,o)=>()=>r(void 0,void 0,void 0,(function*(){var i,l,c;const d=o.value;if(!d)return;const r=document.getElementById("tag-input").value.split(",").map((e=>e.trim())).filter((e=>""!==e)),[s,u]=yield Promise.all([t("notes"),chrome.tabs.query({active:!0,currentWindow:!0})]),m=(null===(i=u[0])||void 0===i?void 0:i.url)||"unknown",v=(null===(l=u[0])||void 0===l?void 0:l.favIconUrl)||"",y=s||[],f={id:`${m}-${d}`,title:(null===(c=u[0])||void 0===c?void 0:c.title)||"unknown",content:d,url:m,iconUrl:v,hostname:"unknown"!==m?new URL(m).hostname:"unknown",createdAt:Date.now(),tags:r};y.push(f),y.sort(((e,t)=>e.hostname.charCodeAt(0)-t.hostname.charCodeAt(0))),console.log("notes data",y),yield n({notes:y}),o.value="",a(e)})),u=e=>r(void 0,void 0,void 0,(function*(){var o;const i=null===(o=e.target.files)||void 0===o?void 0:o[0];if(i)try{const e=yield i.text(),o=JSON.parse(e),l=Array.isArray(o)?o:Array.isArray(o.content)?o.content:[];if(!l.length)return void alert("⚠️ 匯入格式錯誤或沒有任何筆記！");const c=(yield t("notes"))||[],d=l.map((e=>Object.assign(Object.assign({},e),{id:crypto.randomUUID()}))),r=[...c,...d];yield n({notes:r}),alert(`✅ 已匯入 ${d.length} 筆筆記！`);const s=document.getElementById("note-list"),u=document.getElementById("sort-select");a(s,u.value)}catch(e){alert("❌ 匯入失敗，檔案格式可能錯誤！"),console.error(e)}finally{e.target.value=""}}))})();